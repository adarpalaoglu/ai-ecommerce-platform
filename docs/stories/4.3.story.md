---
Status: Draft
Epic: 4
Story: 3
Title: Backend User Role Management
---

### Story

**As an** admin,
**I want** to be able to change a user's role through the API,
**so that** I can grant or revoke store manager permissions.

### Acceptance Criteria

1.  A `GET /api/users` endpoint is created that returns a list of all users, accessible only to admins.
2.  A `PUT /api/users/:id/role` endpoint is created that allows an admin to change a user's role (e.g., from "buyer" to "manager").
3.  The endpoint is protected and can only be accessed by users with the "admin" role.

### Dev Notes

#### Data Models
- `User` model: `id`, `username`, `email`, `hashed_password`, `role` (e.g., "buyer", "manager", "admin"). [Source: architecture/data-models.md]
- Database table: `users` with `id`, `username`, `email`, `hashed_password`, `role` columns. [Source: architecture/database-schema.md]

#### API Specifications
- Standard API response format (JSON). [Source: architecture/api-specification.md]
- Error response structure. [Source: architecture/api-specification.md, architecture/coding-standards.md]
- Use existing JWT authentication middleware for protection. [Source: architecture/coding-standards.md]
- Implement role-based access control for admin-only access. [Source: architecture/coding-standards.md]

#### File Locations
- Backend source code: `apps/api/src/`. [Source: architecture/unified-project-structure.md]
- API endpoint definitions: `apps/api/src/routes/`. [Source: architecture/unified-project-structure.md]
- SQLAlchemy models: `apps/api/src/models/`. [Source: architecture/unified-project-structure.md]
- Pydantic schemas: `apps/api/src/schemas/`. [Source: architecture/unified-project-structure.md]
- Database interaction logic: `apps/api/src/crud/`. [Source: architecture/unified-project-structure.md]
- Authentication and authorization logic: `apps/api/src/auth/`. [Source: architecture/unified-project-structure.md]

#### Testing Requirements
- Backend testing: Unit tests for individual functions/modules, integration tests for API endpoints. [Source: architecture/testing-strategy.md]
- Test organization: `apps/api/tests/unit/` and `apps/api/tests/integration/`. [Source: architecture/testing-strategy.md]
- Testing framework: Pytest. [Source: architecture/tech-stack.md]

#### Technical Constraints
- Backend framework: Python (FastAPI). [Source: architecture/tech-stack.md, architecture/backend-architecture.md]
- Database: PostgreSQL, SQLAlchemy, Alembic. [Source: architecture/tech-stack.md]
- Code quality: Black for formatting, Flake8 for linting, MyPy for type checking. [Source: architecture/coding-standards.md]
- **Assumption**: This story assumes existing authentication and authorization mechanisms are in place for role-based access control.

### Tasks / Subtasks

1.  (AC: 1) Create `GET /api/users` endpoint.
    *   [ ] Implement logic in `apps/api/src/crud/` to fetch all users from the database.
    *   [ ] Define Pydantic schema for user response in `apps/api/src/schemas/`.
    *   [ ] Create FastAPI route in `apps/api/src/routes/` for `GET /api/users`.
    *   [ ] Apply admin role protection to the endpoint.
    *   [ ] Write unit tests for user fetching logic.
    *   [ ] Write integration tests for `GET /api/users` endpoint.
2.  (AC: 2, 3) Create `PUT /api/users/:id/role` endpoint.
    *   [ ] Implement logic in `apps/api/src/crud/` to update a user's role.
    *   [ ] Define Pydantic schema for role update request in `apps/api/src/schemas/`. 
    *   [ ] Create FastAPI route in `apps/api/src/routes/` for `PUT /api/users/:id/role`.
    *   [ ] Apply admin role protection to the endpoint.
    *   [ ] Write unit tests for user role update logic.
    *   [ ] Write integration tests for `PUT /api/users/:id/role` endpoint.

### Change Log

| Date | Version | Description | Author |
|---|---|---|---|
| 2025-08-11 | 1.0 | Initial draft based on Epic 4.3 and architecture documents | Bob (Scrum Master) |

### Dev Agent Record

#### Agent Model Used

#### Debug Log References

#### Completion Notes List

#### File List

### QA Results
