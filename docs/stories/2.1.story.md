---
Status: Done
Epic: 2
Story: 1
Title: Backend User & Auth Setup
---

### Story

**As a** developer,
**I want** to create the backend infrastructure for user registration and JWT-based authentication,
**so that** users can securely create accounts and log in.

### Acceptance Criteria

1.  The `users` table is added to the database with fields for email, hashed password, and role.
2.  API endpoints for user registration (`POST /api/auth/register`) and login (`POST /api/auth/login`) are created.
3.  The login endpoint successfully returns a JWT access token upon valid authentication.
4.  Password hashing (e.g., using passlib) is implemented to securely store user passwords.
5.  A default role of "buyer" is assigned to newly registered users.

### Dev Notes

#### Previous Story Insights

No specific insights from previous stories are directly relevant to this backend-focused story.

#### Data Models

-   **User:** Represents a user of the e-commerce platform. Key attributes: `id`, `email`, `passwordHash`, `firstName`, `lastName`, `createdAt`, `updatedAt`. [Source: docs/architecture/data-models.md]

#### API Specifications

-   **User Registration:** `POST /api/auth/register` [Source: docs/prd/epic-2.md]
-   **User Login:** `POST /api/auth/login` [Source: docs/prd/epic-2.md]
    -   Returns a JWT access token in the format `Bearer <token>` upon successful authentication.

#### Backend Architecture

-   **Serverless Architecture:** Backend will be implemented using individual Lambda functions. [Source: docs/architecture/backend-architecture.md]
-   **Function Organization:** Functions for user management (e.g., `createUser.ts`, `loginUser.ts`) will be located in `src/functions/users/`. [Source: docs/architecture/backend-architecture.md]
-   **Database:** DynamoDB will be used for data storage. The `Users` table will have `id` as Partition Key and attributes like `email`, `passwordHash`, `firstName`, `lastName`, `createdAt`, `updatedAt`. A `email-index` Global Secondary Index will be used for `email`. [Source: docs/architecture/backend-architecture.md]
-   **Data Access Layer:** `DynamoDBDocumentClient` will be used for CRUD operations. A `userRepository` will encapsulate data access logic. [Source: docs/architecture/backend-architecture.md]
-   **Authentication Flow:** The authentication flow will involve Cognito for user authentication and JWT tokens. [Source: docs/architecture/backend-architecture.md]

#### Technical Constraints

-   **Backend Language:** TypeScript [Source: docs/architecture/tech-stack.md]
-   **Backend Framework:** Node.js (Express) [Source: docs/architecture/tech-stack.md]
-   **API Style:** REST [Source: docs/architecture/tech-stack.md]
-   **Database:** DynamoDB [Source: docs/architecture/tech-stack.md]
-   **Authentication:** AWS Cognito [Source: docs/architecture/tech-stack.md]
-   **Password Hashing:** `passlib` (or similar library) should be used for secure password storage. [Source: docs/prd/epic-2.md]

### Tasks / Subtasks

1.  (AC: 1) Add `users` table to the database schema.
    *   [x] Define database table structure for `Users` with `id`, `email`, `hashed_password`, and `role`.
2.  (AC: 2, 4, 5) Create backend API endpoint for user registration (`POST /api/auth/register`).
    *   [x] Implement `create_user` function in `apps/api/src/crud.py`.
    *   [x] Implement password hashing for `hashed_password` field.
    *   [x] Assign default role of "buyer" to new users.
3.  (AC: 2, 3) Create backend API endpoint for user login (`POST /api/auth/login`).
    *   [x] Implement `login_for_access_token` function in `apps/api/src/main.py`.
    *   [x] Validate user credentials against hashed passwords.
    *   [x] Generate and return a JWT access token upon successful authentication.
4.  Create initial unit tests for backend functions and services.
    *   [x] Write unit tests for `create_user` and `login_for_access_token` functions.

### Change Log

| Date | Version | Description | Author |
|---|---|---|---|
| 2025-08-08 | 1.0 | Initial draft based on Epic 2.1 and architecture documents | Bob (Scrum Master Agent) |

### Dev Agent Record

This section is populated by the development agent during implementation

#### Agent Model Used

{{agent_model_name_version}}

#### Debug Log References

#### Completion Notes List

- Implemented user registration and login functionality.
- Added `User` model and Alembic migration.
- Created unit tests for authentication endpoints.

#### File List

- `apps/api/src/models/user.py`
- `apps/api/src/schemas.py`
- `apps/api/src/crud.py`
- `apps/api/src/main.py`
- `apps/api/tests/test_auth.py`
- `apps/api/alembic/versions/7cf7ce56c8d2_add_users_table.py`

### QA Results

### Review Date: 2025-08-08

### Reviewed By: Quinn (Senior Developer QA)

### Code Quality Assessment

The implementation is of good quality. The developer correctly identified the discrepancy between the dev notes and the project structure and proceeded with the correct implementation. The code is clean, well-structured, and easy to understand.

### Refactoring Performed

- **File**: `apps/api/src/main.py`
  - **Change**: Loaded the `SECRET_KEY` from an environment variable instead of hardcoding it.
  - **Why**: Hardcoding secrets is a security risk. Loading them from the environment is a much more secure practice.
  - **How**: Used `os.getenv()` to load the `SECRET_KEY` from the environment, with a fallback value for local development.

### Compliance Check

- Coding Standards: [✓]
- Project Structure: [✓]
- Testing Strategy: [✓]
- All ACs Met: [✓]

### Improvements Checklist

- [x] Refactored `main.py` to load `SECRET_KEY` from environment.

### Security Review

One security issue (hardcoded secret) was found and addressed.

### Performance Considerations

No performance issues were found.

### Final Status

[✓ Approved - Ready for Done]
