---
Status: Draft
Epic: 2
Story: 1
Title: Backend User & Auth Setup
---

### Story

**As a** developer,
**I want** to create the backend infrastructure for user registration and JWT-based authentication,
**so that** users can securely create accounts and log in.

### Acceptance Criteria

1.  The `users` table is added to the database with fields for email, hashed password, and role.
2.  API endpoints for user registration (`POST /api/auth/register`) and login (`POST /api/auth/login`) are created.
3.  The login endpoint successfully returns a JWT access token upon valid authentication.
4.  Password hashing (e.g., using passlib) is implemented to securely store user passwords.
5.  A default role of "buyer" is assigned to newly registered users.

### Dev Notes

#### Previous Story Insights

No specific insights from previous stories are directly relevant to this backend-focused story.

#### Data Models

-   **User:** Represents a user of the e-commerce platform. Key attributes: `id`, `email`, `passwordHash`, `firstName`, `lastName`, `createdAt`, `updatedAt`. [Source: docs/architecture/data-models.md]

#### API Specifications

-   **User Registration:** `POST /api/auth/register` [Source: docs/prd/epic-2.md]
-   **User Login:** `POST /api/auth/login` [Source: docs/prd/epic-2.md]
    -   Returns a JWT access token in the format `Bearer <token>` upon successful authentication.

#### Backend Architecture

-   **Serverless Architecture:** Backend will be implemented using individual Lambda functions. [Source: docs/architecture/backend-architecture.md]
-   **Function Organization:** Functions for user management (e.g., `createUser.ts`, `loginUser.ts`) will be located in `src/functions/users/`. [Source: docs/architecture/backend-architecture.md]
-   **Database:** DynamoDB will be used for data storage. The `Users` table will have `id` as Partition Key and attributes like `email`, `passwordHash`, `firstName`, `lastName`, `createdAt`, `updatedAt`. A `email-index` Global Secondary Index will be used for `email`. [Source: docs/architecture/backend-architecture.md]
-   **Data Access Layer:** `DynamoDBDocumentClient` will be used for CRUD operations. A `userRepository` will encapsulate data access logic. [Source: docs/architecture/backend-architecture.md]
-   **Authentication Flow:** The authentication flow will involve Cognito for user authentication and JWT tokens. [Source: docs/architecture/backend-architecture.md]

#### Technical Constraints

-   **Backend Language:** TypeScript [Source: docs/architecture/tech-stack.md]
-   **Backend Framework:** Node.js (Express) [Source: docs/architecture/tech-stack.md]
-   **API Style:** REST [Source: docs/architecture/tech-stack.md]
-   **Database:** DynamoDB [Source: docs/architecture/tech-stack.md]
-   **Authentication:** AWS Cognito [Source: docs/architecture/tech-stack.md]
-   **Password Hashing:** `passlib` (or similar library) should be used for secure password storage. [Source: docs/prd/epic-2.md]

### Tasks / Subtasks

1.  (AC: 1) Add `users` table to the database schema.
    *   [ ] Define DynamoDB table structure for `Users` with `id`, `email`, `passwordHash`, `firstName`, `lastName`, `createdAt`, `updatedAt`.
    *   [ ] Implement `email-index` Global Secondary Index.
2.  (AC: 2, 4, 5) Create backend API endpoint for user registration (`POST /api/auth/register`).
    *   [ ] Implement `createUser` Lambda function in `src/functions/users/createUser.ts`.
    *   [ ] Implement password hashing for `passwordHash` field.
    *   [ ] Assign default role of "buyer" to new users.
    *   [ ] Integrate with `userRepository` to save user data to DynamoDB.
3.  (AC: 2, 3) Create backend API endpoint for user login (`POST /api/auth/login`).
    *   [ ] Implement `loginUser` Lambda function in `src/functions/users/loginUser.ts`.
    *   [ ] Validate user credentials against hashed passwords.
    *   [ ] Generate and return a JWT access token upon successful authentication.
4.  Implement `userRepository` for DynamoDB operations.
    *   [ ] Create `userRepository` in `apps/api/src/services/`.
    *   [ ] Implement `createUser`, `getUserByEmail`, and `updateUser` methods.
5.  Create initial unit tests for backend functions and services.
    *   [ ] Write unit tests for `createUser` Lambda function.
    *   [ ] Write unit tests for `loginUser` Lambda function.
    *   [ ] Write unit tests for `userRepository`.

### Change Log

| Date | Version | Description | Author |
|---|---|---|---|
| 2025-08-08 | 1.0 | Initial draft based on Epic 2.1 and architecture documents | Bob (Scrum Master Agent) |

### Dev Agent Record

This section is populated by the development agent during implementation

#### Agent Model Used

{{agent_model_name_version}}

#### Debug Log References

#### Completion Notes List

#### File List

### QA Results

Results from QA Agent QA review of the completed story implementation
