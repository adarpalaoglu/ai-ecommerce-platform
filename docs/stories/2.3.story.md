---
Status: Draft
Epic: 2
Story: 3
Title: Backend Cart Functionality
---

### Story

**As a** developer,
**I want** to create the backend API endpoints for managing a user's shopping cart,
**so that** items can be added, updated, and removed.

### Acceptance Criteria

1.  The `cart_items` table is added to the database, linking users, products, and quantities.
2.  A `GET /api/cart` endpoint is created to retrieve the current user's cart contents.
3.  A `POST /api/cart/items` endpoint is created to add a new item to the cart.
4.  `PUT /api/cart/items/:id` and `DELETE /api/cart/items/:id` endpoints are created to update the quantity of an item or remove it from the cart.
5.  All cart endpoints are protected and require a valid JWT for access.

### Dev Notes

#### Previous Story Insights

Story 2.2 implemented frontend user authentication, which provides the JWT for protecting these new cart endpoints.

#### Data Models

-   A new `CartItem` model will be needed, linking `User` and `Product` with a `quantity`. [Source: docs/architecture/data-models.md]
-   The `Product` model has `id`, `name`, `description`, `price`, `imageUrl`, `category`, `stock`, `createdAt`, `updatedAt`. [Source: docs/architecture/data-models.md]
-   The `User` model has `id`, `email`, `passwordHash`, `firstName`, `lastName`, `createdAt`, `updatedAt`. [Source: docs/architecture/data-models.md]

#### API Specifications

-   API Style: REST 1.0 [Source: docs/architecture/tech-stack.md]
-   Backend Framework: Node.js (Express) [Source: docs/architecture/tech-stack.md]
-   Authentication: AWS Cognito, JWT-based. Endpoints will need protection. [Source: docs/architecture/tech-stack.md, docs/architecture/backend-architecture.md]
-   New Endpoints:
    -   `GET /api/cart` [Source: docs/prd/epic-2.md]
    -   `POST /api/cart/items` [Source: docs/prd/epic-2.md]
    -   `PUT /api/cart/items/:id` [Source: docs/prd/epic-2.md]
    -   `DELETE /api/cart/items/:id` [Source: docs/prd/epic-2.md]

#### Database

-   DynamoDB is the chosen database. [Source: docs/architecture/tech-stack.md]
-   A `cart_items` table will be needed. The `database-schema.md` shows examples of DynamoDB table definitions. [Source: docs/architecture/database-schema.md]
-   Data Access Layer: `DynamoDBClient` and `DynamoDBDocumentClient` are used for CRUD operations. [Source: docs/architecture/backend-architecture.md]

#### File Locations

-   Backend application code is in `apps/api/src/`. [Source: docs/architecture/unified-project-structure.md]
-   Individual Lambda functions are in `apps/api/src/functions/`. [Source: docs/architecture/unified-project-structure.md]
-   Business logic is in `apps/api/src/services/`. [Source: docs/architecture/unified-project-structure.md]
-   Data models are in `apps/api/src/models/`. [Source: docs/architecture/unified-project-structure.md]

#### Testing Requirements

-   Backend Testing: Jest, Supertest for unit and integration testing. [Source: docs/architecture/tech-stack.md]
-   Test Organization: Unit tests for Lambda functions in `apps/api/src/functions/` and business logic in `apps/api/src/services/`. Integration tests in `apps/api/tests/integration/`. [Source: docs/architecture/testing-strategy.md]
-   **Test Data Requirements**:
    -   **Positive Cases**: Test adding/updating/deleting items for a logged-in user with valid product IDs and quantities.
    -   **Edge Cases**:
        -   Adding a product with quantity 0 or negative.
        -   Adding a product that does not exist.
        -   Updating quantity to exceed product stock.
        -   Updating/deleting an item not in the cart.
        -   Empty cart scenarios.
    -   **Negative Cases**: Test unauthorized access to cart endpoints (missing/invalid JWT).

#### Technical Constraints

-   Backend Language: TypeScript 5.x [Source: docs/architecture/tech-stack.md]
-   Type Sharing: Always define types in `packages/shared/src/types`. [Source: docs/architecture/coding-standards.md]
-   Error Handling: All API routes must use the standard error handler for consistent error responses. [Source: docs/architecture/coding-standards.md]

#### Security Considerations

-   **Data Protection**: All cart data at rest (DynamoDB) will be encrypted using AWS KMS. Data in transit will be encrypted using TLS/HTTPS. [Source: docs/architecture/security-and-performance.md]
-   **Sensitive Data Handling**: No sensitive user data related to the cart will be logged directly. [Source: docs/architecture/security-and-performance.md]
-   **Vulnerability Prevention**:
    -   **Input Validation**: Joi/Yup for schema validation on all incoming API requests to cart endpoints. [Source: docs/architecture/security-and-performance.md]
    -   **Access Control**: Role-Based Access Control (RBAC) will be implemented to ensure only authenticated users can manage their own carts. [Source: docs/architecture/security-and-performance.md]
    -   **Rate Limiting**: Consider implementing rate limiting for cart modification endpoints to prevent abuse. [Source: docs/architecture/security-and-performance.md]


### Tasks / Subtasks

1.  (AC: 1) Add `cart_items` table to the database.
    *   [ ] Define `CartItem` schema in `apps/api/src/models/`.
    *   [ ] Create database migration for `cart_items` table.
2.  (AC: 2, 3, 4) Implement backend API endpoints for cart management.
    *   [ ] Create `GET /api/cart` endpoint to retrieve cart contents.
    *   [ ] Create `POST /api/cart/items` endpoint to add items to cart.
    *   [ ] Create `PUT /api/cart/items/:id` endpoint to update item quantity.
    *   [ ] Create `DELETE /api/cart/items/:id` endpoint to remove items from cart.
3.  (AC: 5) Protect all cart endpoints with JWT authentication.
    *   [ ] Implement JWT validation middleware for cart endpoints.
4.  Write unit and integration tests for cart functionality.
    *   [ ] Write unit tests for cart service logic.
    *   [ ] Write integration tests for cart API endpoints.

### Change Log

| Date | Version | Description | Author |
|---|---|---|---|
| 2025-08-08 | 1.0 | Initial draft based on Epic 2.3 and architecture documents | Bob (Scrum Master Agent) |

### Dev Agent Record

#### Agent Model Used

#### Debug Log References

#### Completion Notes List

#### File List

#### QA Results
